<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SemÃ¡foro â€“ Laboratorio 5G</title>
    <style>
      :root {
        --bg: #0f172a;
        --card: #0b1220aa;
        --text: #e5e7eb;
        --accent: #22d3ee;
      }
      * {
        box-sizing: border-box;
        font-family: system-ui, Segoe UI, Roboto, Inter, Arial;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(135deg, #0b1020, #1e293b);
        color: var(--text);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      .card {
        background: var(--card);
        padding: 32px;
        border-radius: 16px;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        width: 320px;
      }
      #light {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: red;
        margin: 20px auto;
      }
      a {
        color: var(--accent);
        text-decoration: none;
        font-size: 0.9rem;
        margin-top: 18px;
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>ðŸš¦ SemÃ¡foro Inteligente</h1>
      <div id="light"></div>
      <p id="result">Esperando alerta...</p>
      <p id="packet">â€”</p>
      <a href="./index.html">â¬… Volver al inicio</a>
    </div>

    <script>
      const wsProto = location.protocol === "https:" ? "wss:" : "ws:";
      const ws = new WebSocket(wsProto + "//" + location.host);
      ws.onmessage = async (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === "ALERT") {
          const now = Date.now();
          const clientLatency =
            typeof msg.clientSentAt === "number"
              ? now - msg.clientSentAt
              : null;
          const serverLatency =
            typeof msg.serverSentAt === "number"
              ? now - msg.serverSentAt
              : null;
          const latency = clientLatency ?? serverLatency ?? 0;
          const light = document.getElementById("light");
          light.style.background = "green";
          setTimeout(() => (light.style.background = "red"), 1000);
          document.getElementById(
            "result"
          ).textContent = `Alerta (${msg.networkType}) recibida en ${latency} ms`;
          document.getElementById(
            "packet"
          ).textContent = `Paquete: ${msg.packetSize || "N/D"} Â· Clienteâ†’SemÃ¡foro: ${
            clientLatency != null ? `${clientLatency.toFixed(0)} ms` : "N/D"
          } Â· Serverâ†’SemÃ¡foro: ${
            serverLatency != null ? `${serverLatency.toFixed(0)} ms` : "N/D"
          }`;

          await fetch("/latency", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              networkType: msg.networkType,
              latencyMs: latency,
              packetSize: msg.packetSize,
            }),
          });
        }
      };
    </script>
  </body>
</html>
